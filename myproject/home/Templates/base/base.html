{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>SocialHub - K·∫øt n·ªëi m·ªçi l√∫c</title>
    <link rel="stylesheet" href="{% static 'base/style.css' %}">
    <script src="{% static 'base/script.js' %}" defer></script>

    {% block extra_css %}
    <!-- CSS ri√™ng c·ªßa t·ª´ng trang s·∫Ω ch√®n v√†o ƒë√¢y -->
    {% endblock %}
</head>
<body>

    <!-- Navbar chung -->
    <nav class="navbar">
        <div class="nav-content">
            <a href="{% url 'home' %}" class="logo">SocialHub</a>
            <div class="search-box">
                <form action="{% url 'findfriend' %}" method="get">
                  <input 
                    type="text" 
                    id="searchInput" 
                    name="q" 
                    class="search-input" 
                    placeholder="T√¨m ki·∫øm b·∫°n b√®..."
                  >
                </form>
              </div>
              
            <div class="nav-icons">
                <a href="{% url 'home' %}" class="nav-icon" title="Trang ch·ªß" style="text-decoration:none">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                </a>
                <a href="{% url 'home' %}" class="nav-icon" title="Tin nh·∫Øn" style="text-decoration:none">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                    </svg>
                </a>
                
                <div class="nav-icon has-dropdown" title="Th√¥ng b√°o">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                    </svg>
                    <span id="notification-count" class="notification-badge">{{ unread_count }}</span>
                    <div id="notification-list" class="dropdown">
                        {% for notification in notifications %}
                            <div class="dropdown-item {% if not notification.is_read %}unread{% endif %}" data-id="{{ notification.id }}">
                                {% if notification.post %}
                                    {% if notification.comment %}
                                        <a href="{% url 'personal' %}?highlight={{ notification.post.id }}&comment={{ notification.comment.id }}">
                                            {{ notification.message }}
                                        </a>
                                    {% else %}
                                        <a href="{% url 'personal' %}?highlight={{ notification.post.id }}">
                                            {{ notification.message }}
                                        </a>
                                    {% endif %}
                            {% else %}
                                üì¢ {{ notification.message }}
                            {% endif %}
                                {% comment %} <p style="font-size:0.8rem;position:relative;left:125px;">{{notification.created_at|timesince}} ago</p> {% endcomment %}
                            </div>
                        {% empty %}
                            <div class="dropdown-item" style="padding:0.5rem 0.8rem">Kh√¥ng c√≥ th√¥ng b√°o n√†o</div>
                        {% endfor %}
                    </div>
                </div>

<script>
        // T·∫°o k·∫øt n·ªëi websocket
        const socket = new WebSocket(
            `ws://${window.location.host}/ws/notifications/`
        );
    
    socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    document.getElementById('notification-count').innerText = data.count;

    const list = document.getElementById('notification-list');

    let html = "";
    if (data.post_id) {
        if (data.comment_id) {
            // C√≥ c·∫£ post & comment
            html = `
                <div class="dropdown-item unread" data-id="${data.id}">
                    <a href="/personal?highlight=${data.post_id}&comment=${data.comment_id}">
                        ${data.message}
                    </a>
                </div>`;
        } else {
            // Ch·ªâ c√≥ post
            html = `
                <div class="dropdown-item unread" data-id="${data.id}">
                    <a href="/personal?highlight=${data.post_id}">
                        ${data.message}
                    </a>
                </div>`;
        }
    } else {
        // Th√¥ng b√°o ch·ªâ l√† text
        html = `
            <div class="dropdown-item unread" data-id="${data.id}">
                üì¢ ${data.message}
            </div>`;
    }

    list.insertAdjacentHTML("afterbegin", html);

    // G·∫Øn s·ª± ki·ªán click cho <a> m·ªõi
    const newLink = list.querySelector(".dropdown-item:first-child a");
    if (newLink) {
        newLink.addEventListener("click", function(e){
            e.preventDefault();
            const notificationDiv = this.closest('.dropdown-item');
            const notificationId = notificationDiv.dataset.id;
            const href = this.href;

            fetch("{% url 'mark_notification_read' %}?id=" + notificationId)
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok') {
                    notificationDiv.classList.remove('unread');
                    let countSpan = document.getElementById('notification-count');
                    let count = parseInt(countSpan.innerText);
                    countSpan.innerText = Math.max(0, count - 1);
                }
                window.location.href = href;
            });
        });
    }
};
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('#notification-list a').forEach(link => {
            link.addEventListener('click', function(e){
                e.preventDefault();
                const notificationDiv = this.closest('.dropdown-item');
                const notificationId = notificationDiv.dataset.id;
                const href = this.href;
    
                fetch("{% url 'mark_notification_read' %}?id=" + notificationId)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'ok') {
                        notificationDiv.classList.remove('unread');
                        let countSpan = document.getElementById('notification-count');
                        let count = parseInt(countSpan.innerText);
                        countSpan.innerText = Math.max(0, count - 1);
                    }
                    window.location.href = href;
                });
            });
        });
    });
</script>

                <div class="nav-icon has-dropdown" title="T√†i kho·∫£n">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <div class="dropdown">
                        <a href="{% url 'personal' %}">Trang c√° nh√¢n</a>
                        <a href="{% url 'logout' %}" style="color:#ef4444">ƒêƒÉng xu·∫•t</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- N·ªôi dung t·ª´ng trang -->
    <main>
        {% block content %}
        {% endblock %}
    </main>

    
    {% block extra_js %}
    <!-- JS ri√™ng c·ªßa t·ª´ng trang s·∫Ω ch√®n v√†o ƒë√¢y -->
    {% endblock %}
</body>
</html>