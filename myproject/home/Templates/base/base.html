{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>SocialHub - K·∫øt n·ªëi m·ªçi l√∫c</title>
    <link rel="stylesheet" href="{% static 'base/style.css' %}">
    <script src="{% static 'base/script.js' %}" defer></script>

    {% block extra_css %}
    <!-- CSS ri√™ng c·ªßa t·ª´ng trang s·∫Ω ch√®n v√†o ƒë√¢y -->
    {% endblock %}
</head>
<body>

    <!-- Navbar chung -->
    <nav class="navbar">
        <div class="nav-content">
            <a href="{% url 'home' %}" class="logo">SocialHub</a>
            <div class="search-box">
                <input type="text" class="search-input" placeholder="T√¨m ki·∫øm b·∫°n b√®">
            </div>
            <div class="nav-icons">
                <a href="{% url 'home' %}" class="nav-icon" title="Trang ch·ªß" style="text-decoration:none">üè†</a>
                <a href="{% url 'home' %}" class="nav-icon" title="Tin nh·∫Øn" style="text-decoration:none">üí¨</a>
                
                <div class="nav-icon has-dropdown" title="Th√¥ng b√°o">
                    üîî
                    <span id="notification-count" class="notification-badge">{{ unread_count }}</span>
                    <div id="notification-list" class="dropdown">
                        {% for notification in notifications %}
                            <div class="dropdown-item {% if not notification.is_read %}unread{% endif %}" data-id="{{ notification.id }}">
                                {% if notification.post %}
                                    <a href="{% url 'personal' %}?highlight={{ notification.post.id }}">{{ notification.message }}</a>
                                {% else %}
                                    üì¢ {{ notification.message }}
                                {% endif %}
                                {% comment %} <p style="font-size:0.8rem;position:relative;left:125px;">{{notification.created_at|timesince}} ago</p> {% endcomment %}
                            </div>
                        {% empty %}
                            <div class="dropdown-item" style="padding:0.5rem 0.8rem">Kh√¥ng c√≥ th√¥ng b√°o n√†o</div>
                        {% endfor %}
                    </div>
                </div>
                
                <style>
                    /* CSS cho th√¥ng b√°o ch∆∞a ƒë·ªçc */
                    .dropdown-item.unread {
                    font-weight: bold;      /* ch·ªØ ƒë·∫≠m */
                    background-color: #f0f8ff; /* n·ªÅn nh·∫°t ƒë·ªÉ n·ªïi b·∫≠t */
                    }   
                </style>
{% comment %} 
                <script>
                    const socket = new WebSocket(
                        `ws://${window.location.host}/ws/notifications/`
                    );
                
                    socket.onmessage = function(e) {
                        const data = JSON.parse(e.data);
                        document.getElementById('notification-count').innerText = data.count;
                
                        const list = document.getElementById('notification-list');
                        const item = document.createElement('div');
                        item.classList.add('dropdown-item');
                        item.textContent = data.message;
                        list.prepend(item); // Th√™m l√™n ƒë·∫ßu
                    };
                </script>
                 {% endcomment %}


<script>
        // T·∫°o k·∫øt n·ªëi websocket
        const socket = new WebSocket(
            `ws://${window.location.host}/ws/notifications/`
        );
    
    socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    document.getElementById('notification-count').innerText = data.count;

    const list = document.getElementById('notification-list');

    let html = "";
    if (data.post_id) {
        // N·∫øu noti g·∫Øn v·ªõi b√†i post ‚Üí c√≥ <a>
        html = `
            <div class="dropdown-item unread" data-id="${data.id}">
                <a href="/personal?highlight=${data.post_id}">${data.message}</a>
            </div>`;
    } else {
        // N·∫øu ch·ªâ l√† th√¥ng b√°o text
        html = `
            <div class="dropdown-item unread" data-id="${data.id}">
                üì¢ ${data.message}
            </div>`;
    }

    list.insertAdjacentHTML("afterbegin", html);

    // G·∫Øn s·ª± ki·ªán click cho <a> m·ªõi
    const newLink = list.querySelector(".dropdown-item:first-child a");
    if (newLink) {
        newLink.addEventListener("click", function(e){
            e.preventDefault();
            const notificationDiv = this.closest('.dropdown-item');
            const notificationId = notificationDiv.dataset.id;
            const href = this.href;

            fetch("{% url 'mark_notification_read' %}?id=" + notificationId)
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok') {
                    notificationDiv.classList.remove('unread');
                    let countSpan = document.getElementById('notification-count');
                    let count = parseInt(countSpan.innerText);
                    countSpan.innerText = Math.max(0, count - 1);
                }
                window.location.href = href;
            });
        });
    }
};</script>
















                 

                
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('#notification-list a').forEach(link => {
            link.addEventListener('click', function(e){
                e.preventDefault();
                const notificationDiv = this.closest('.dropdown-item');
                const notificationId = notificationDiv.dataset.id;
                const href = this.href;
    
                fetch("{% url 'mark_notification_read' %}?id=" + notificationId)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'ok') {
                        notificationDiv.classList.remove('unread');
                        let countSpan = document.getElementById('notification-count');
                        let count = parseInt(countSpan.innerText);
                        countSpan.innerText = Math.max(0, count - 1);
                    }
                    window.location.href = href;
                });
            });
        });
    });
</script>
                




                <div class="nav-icon has-dropdown" title="T√†i kho·∫£n">üë§
                    <div class="dropdown">
                        <a href="{% url 'personal' %}">Trang c√° nh√¢n</a>
                        <a href="{% url 'logout' %}" style="color:red">ƒêƒÉng xu·∫•t</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- N·ªôi dung t·ª´ng trang -->
    <main>
        {% block content %}
        {% endblock %}
    </main>

    
    {% block extra_js %}
    <!-- JS ri√™ng c·ªßa t·ª´ng trang s·∫Ω ch√®n v√†o ƒë√¢y -->
    {% endblock %}
</body>
</html>
